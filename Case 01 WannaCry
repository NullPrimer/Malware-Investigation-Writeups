### WannaCry Investigation

This mini report is to highlight my reasrach into the malious software know as WannaCry.

Contents:
- The Kill Switch
- Worm Component
- Eternal Blue
- My Custom Yara Rule for hunting WannaCry

This ransomware utilizes a hybrid cryptographic model in which it combines an asymmetric cryptography with a symmetric cryptography.

Wannacry uses the follwing API's to achive this.

- CryptGenKey is used to generate RSA key pair. 
- CryptEncrypt is used for encrypting the files using the symmetric key - AES in this case 
- CryptImportKey is for importing the Attacker’s public key (APU) 
- CryptExportKey is used for exporting the AES keys that are encrypted using the VPU 
- CryptDestroyKey is to destroy the memory area where the key was held in such a way that the key can never be recovered
- EncryptFileA is used to encrypt a file or directory.
- DecryptFileA is used to decrypt an encrypted file or directory.
- EnumSystemLocalesA is used enumerate installed locale identifiers, all of the supported identifiers or alternate sort identifiers, according to which flag is passed to the API. 
Can be used to geofence infection campaigns or avoid infecting systems from a certain region/country. 
It can also be used to jump to allocated shellcode and execute it.

#### The Kill Switch
Upon activation this malware will attempt to reach put to the URL - hhttp://www[DOT]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[DOT]com

As long as the domain is registred Wannacry will not infect the host system.
A quick way to view this string is to either use the cmd strings or floss.exe followed by the name of the file/sample houseing the malware.


#### Worm Component
API's used by the Worm component enabling WannaCry to achive persistance.
- CryptGenRandom 
- GetCurrentThread
- GetStartupInfoA
- StartServiceCtrDidpatcherA
- CreateServiceA
- StartSrrviceA
- CryptAcquireContextA
- OpenServiceA
- GetAdaptersInfo
- InternetOpenUrlA



(May be able to use the same dll to reverse engineer a decrypt task?)

APIs:
1
Function Name

EncryptFileA
Library

Advapi32.dll

2
Function Name

DecryptFileA
Library

Advapi32.dll

3
Function Name

EnumSystemLocalesA
Library

Kernel32.dll

Associated Attacks

#### Eternal Blue

How does WannaCry achieve persistence?

In service mode, the malware first updates the service config so that failure actions occur if the service exits without entering a SERVICE_STOPPED state. 
The malware then executes the service function, which registers the service handlers and attempts exploitation of MS17-010 against identified SMB services. 
This allows remote code execution and enables spreading across the network. 
This execution is performed in a thread, and the service exits after 24 hours regardless of the status of the thread.

Rather, my research shows this nasty worm was spread via an operation that hunts down vulnerable public facing SMB ports 
- and then uses the alleged NSA-leaked EternalBlue exploit to get on the network and then the (also NSA alleged) DoublePulsar exploit to establish persistence and allow for the installation.

#### Mitigations
Implement regular backups of all data to be stored as air gapped, password protected copies offline. Ensure these copies are not accessible for modification or deletion from any system where the original data resides. 
• Implement network segmentation, such that all machines on your network are not accessible from every other machine. 
• Install and regularly update antivirus software on all hosts, and enable real time detection. • Install updates/patch operating systems, software, and firmware as soon as updates/patches are released. 
• Review domain controllers, servers, workstations, and active directories for new or unrecognized user accounts. 
• Audit user accounts with administrative privileges and configure access controls with least privilege in mind. Do not give all users administrative privileges. 
• Disable unused remote access/Remote Desktop Protocol (RDP) ports and monitor remote access/RDP logs for any unusual activity. 
• Consider adding an email banner to emails received from outside your organization. 
• Disable hyperlinks in received emails. 
• Use double authentication when logging into accounts or services. 
• Ensure routine auditing is conducted for all accounts. 
• Ensure all the identified IOCs are input into the network SIEM for continuous monitoring and alerts.
